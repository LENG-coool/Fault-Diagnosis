---
prev: false
next: false
---
<br><br>

# SHAP＋열역학 시뮬레이션 보조 랜덤 포레스트 기반 설명 가능한 고장 진단
## 서론{#서론}
오늘은 최근 《Measurement》에 발표된 첨단 논문을 소개합니다: **《Thermodynamic Simulation-assisted Random Forest: Towards explainable fault diagnosis of combustion chamber components of marine diesel engines》**.

인공지능 분야에서는 종종 이런 난감한 상황을 마주합니다: 모델 정확도는 99%에 달하지만, 엔지니어는 쉽게 사용하지 못합니다. 왜일까요? 선박 엔진 진단처럼 생명·재산 안전이 걸린 영역에서는 “블랙박스” 모델이 주는 숫자 하나만으로는 부족하며, 설명 가능성이 필요하기 때문입니다.

이 글은 **열역학 시뮬레이션과 랜덤 포레스트**(RF)를 결합하는 방법을 보여줄 뿐 아니라, SHAP 알고리즘을 심층적으로 적용해 복잡 시스템의 고장 진단에 새로운 “투시” 관점을 제공합니다. 즉, 고장을 정확히 찾아내는 동시에 어떤 열역학 파라미터가 작동했는지도 설명합니다.

## 한계 기여도{#한계기여도}
SHAP의 핵심 목표는 각 특징이 최종 예측 결과에 얼마나 기여했는지를 답하는 것입니다. 고장 진단에서는 어떤 열역학 파라미터가 모델이 해당 고장으로 판단하게 만들었는지를 의미합니다.

일반적인 고장 진단은 모델을 학습한 뒤 데이터를 넣고 결과를 출력하면 끝입니다. 그러나 설명 가능한 고장 진단은 이를 역으로 분해해, 각 열역학 파라미터의 기여 정도를 추정합니다. 논리는 다음과 같습니다.

랜덤 포레스트 모델을 예로 들면, 내부에는 많은 결정 트리가 있고 각 트리는 분류를 수행합니다. 각 트리는 자신이 분류한 고장 유형에 투표하며, 가장 많은 표를 얻은 고장이 랜덤 포레스트의 최종 출력이 됩니다.

데이터를 랜덤 포레스트에 입력하면, 고장 $k$의 예측 점수는 $f$=고장 $k$에 투표한 결정 트리의 수입니다. 이 점수는 열역학 파라미터 $i$와 파라미터 $i$를 제외한 파라미터 집합 $S$를 함께 입력했을 때의 예측 점수 $f(S\cup\{i\})$입니다.

파라미터 $i$ 단독의 기여를 알고 싶다면, 파라미터 집합 $S$만 입력했을 때의 예측 점수 $f(S)$를 계산해 두 값을 빼면 됩니다. 그 차이가 파라미터 $i$의 한계 기여도 $\Delta\phi(S)$입니다:
$$ \Delta \phi_{\scriptscriptstyle i}(S) = f(S \cup \{i\}) - f(S) $$

파라미터 $i$의 한계 기여도는 고장 $k$ 판단에서의 영향(부호와 크기)을 나타냅니다:
- 파라미터 $i$를 추가했을 때 고장 $k$의 확률(예측 점수)이 증가하면, 파라미터 $i$는 고장 $k$에 **긍정적 영향**을 미칩니다(고장의 유인 중 하나).
- 파라미터 $i$를 추가했을 때 예측 점수가 감소하면, 파라미터 $i$는 고장 $k$에 **부정적 영향**을 미칩니다(고장의 유인이 아님).
- 한계 기여도 값이 클수록 파라미터 $i$의 영향이 더 크며, 고장 근본 원인에서 더 지배적인 위치를 차지합니다.

## 한계 기여도에서 SHAP 값으로{#SHAP값}
한 개의 파라미터에는 여러 개의 한계 기여도가 존재합니다. 파라미터 집합 $S$의 조합이 여러 가지이기 때문입니다.

예를 들어 P1–P4 네 개의 열역학 파라미터가 있을 때, P1의 한계 기여도를 계산하려면 P1을 제외한 파라미터 집합은 {P2,P3,P4}, {P2,P3}, {P3,P4}, {P2,P4}, {P2}, {P3}, {P4}, ∅ 총 8가지입니다. 따라서 P1의 한계 기여도도 8개가 됩니다.

SHAP 값은 해당 파라미터의 모든 한계 기여도의 **가중 평균**이며, 수식은 다음과 같습니다:
$$ \phi_{\scriptscriptstyle i}(f,x) = \sum_{S \subseteq N \setminus \{i\}} \frac{|S|!(n - |S| - 1)!}{n!} [f(S \cup \{i\}) - f(S)] $$
여기서 $n$은 전체 파라미터 개수, $|S|$는 집합 $S$의 원소 개수입니다.

SHAP 값은 고장 진단에서 해당 파라미터의 중요도를 나타냅니다. SHAP 값이 클수록 모델의 고장 분류에 더 큰 영향을 주며, 이를 통해 더 판단 가치가 높은 핵심 파라미터를 선별할 수 있습니다.

## Tree SHAP: 계산을 “빠르게”{#Tree}
일반적인 SHAP 값 계산은 모든 파라미터 조합을 순회해야 하므로 효율이 매우 낮습니다. Tree SHAP는 결정 트리의 계층 구조를 이용해 경로상의 분기 기여도로 SHAP 값을 직접 계산합니다. 즉, 샘플이 결정 트리에서 **실제로 거치는 경로**의 파라미터만 계산하여 효율을 크게 높입니다.

### 예시 설명:
<img src="/图片1.png" style="width: 50%; margin: 0 auto; display: block;" />
<p align="center" style="color: grey">Tree Shape 경로도</p>
위 그림처럼 4개의 파라미터(파라미터 1–4)로 구성된 결정 트리가 있다고 가정합니다. 일반 SHAP는 모든 파라미터 조합을 계산해야 하지만, 샘플이 실제로 거친 경로가 “파라미터 1 → 파라미터 2 → 파라미터 3 → 고장 2”라면 Tree SHAP는 이 3개 파라미터 조합만 계산하여 계산 과정을 단순화합니다.

## 설명 가능성 분석(피스톤 링 마모 F4 고장 예){#설명가능성분석}
![图片描述](/图片2.png)
위 그림은 피스톤 링 마모(F4 고장)의 SHAP 값 다차원 분석입니다. 그림(a)은 폭포도, 그림(b)는 벌떼도입니다.

### 1. 폭포도(그림 a)
- 역할: **단일 F4 고장 샘플**의 판정 이유를 설명
- 논리: 모든 샘플의 평균 예측 수준 $E[f(X)] = -1.797$에서 시작하여 각 파라미터의 SHAP 값을 누적해 최종 예측 점수 1.464를 얻음
- 핵심 결론: 붉은 파라미터(정의 영향), 파란 파라미터(부의 영향) 중에서 **P12 터보차저 전 배기 온도, P6 블로우바이 열류, P14 터보차저 후 배기 온도, P7 터보차저 후 배기 온도**의 SHAP 절댓값이 가장 커, F4로 판정된 핵심 원인임

### 2. 벌떼도(그림 b)
- 역할: **모든 F4 고장 샘플**에 대한 전역 파라미터 중요도 표시
- 논리: 세로축은 파라미터, 가로축은 SHAP 값(상단 가로축은 평균 SHAP 값)이며, 파라미터가 위로 갈수록 SHAP 값이 크고 고장 판정에 더 중요함
- 핵심 결론:
	- P11(터보차저 전 배기 압력)의 평균 SHAP 값이 가장 높아 F4 고장의 전역 핵심 지표임
	- P11의 낮은 값 샘플이 SHAP 양의 영역에 많이 분포하여, “P11이 너무 낮음”이 피스톤 링 마모의 주요 특징임을 시사
	- 물리적 메커니즘: 피스톤 링 마모 → 밀봉 실패 → 블로우바이 증가 → 배기 시스템 열역학 불균형 → P11 감소

### 3. 핵심 결론
선박 디젤 엔진 연소실의 피스톤 링 마모(F4 고장)의 주요 근본 원인은 다음과 같습니다:
- P11 터보차저 전 배기 압력이 너무 낮음
- P12 터보차저 전 배기 온도가 너무 낮음
- P7 터보차저 후 배기 온도가 너무 낮음
- P6 블로우바이 열유량이 너무 높음

## 원문 문헌{#원문문헌}
*C. Luo, M. Zhao, X. Fu, S. Zhong, S. Fu, K. Zhang, X. Yu. Thermodynamic simulation-assisted random forest: Towards explainable fault diagnosis of combustion chamber components of marine diesel engines [J]. Measurement, 2025, 251: 117252.*

<br>
<hr>
<div style="display: flex; justify-content: flex-end; padding: 20px 0;">
	<a href="https://ts-rf.github.io/ko/" 
		 style="text-decoration: none; color: inherit; border: 1px solid #e2e2e3; padding: 12px 24px; border-radius: 8px; transition: border-color 0.25s; background-color: var(--vp-c-bg-soft);">
		<div style="font-size: 12px; color: var(--vp-c-text-2); margin-bottom: 4px;">원문 문헌</div>
		<div style="font-size: 16px; color: var(--vp-c-brand); font-weight: 600;">여기를 클릭 →</div>
	</a>
</div>
